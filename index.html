<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Bảng Thông Tin Học Sinh</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f8ff;
      padding: 20px;
      text-align: center;
    }

    h2 {
      color: #2a4d69;
    }

    input, select {
      padding: 8px;
      font-size: 16px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #aaa;
    }

    button {
      padding: 8px 14px;
      font-size: 16px;
      background-color: #2a9d8f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
    }

    button:hover {
      background-color: #21867a;
    }

    table {
      margin: 20px auto 40px auto;
      border-collapse: collapse;
      width: 95%;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #f1f1f1;
    }

    td input, td select {
      width: 90%;
      padding: 6px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #aaa;
      box-sizing: border-box;
    }

    .group-title {
      margin-top: 40px;
      color: #2a4d69;
      font-weight: bold;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <h2>Bảng Thông Tin Học Sinh</h2>

  <div>
    <input
      type="text"
      id="nameInput"
      placeholder="Nhập tên để tìm hoặc thêm..."
      aria-label="Tên học sinh"
      oninput="filterTable()"
    />
    <button type="button" onclick="showAddForm()">Thêm mới</button>
  </div>

  <div id="tablesContainer">
    <!-- Bảng các nhóm sẽ hiện ở đây -->
  </div>

  <script>
    const data = [
      { name: "6.1-01 Anh", age: 11, class: "6.1", address: "THCS Nguyễn Trãi", hocphi: "Có" },
      { name: "6.1-02 An", age: 11, class: "6.1", address: "THCS Hùng Vương", hocphi: "Không" },
      { name: "6.2-01 Khang", age: 12, class: "6.2", address: "THCS Nguyễn Du", hocphi: "Có" }
    ];

    let editingIndex = -1;
    let addingNew = false;

    function groupByClass(filteredData) {
      const groups = {};
      filteredData.forEach((person) => {
        if(!groups[person.class]) {
          groups[person.class] = [];
        }
        groups[person.class].push(person);
      });
      return groups;
    }

    function renderTable(filter = "") {
      const container = document.getElementById("tablesContainer");
      container.innerHTML = "";

      const filteredData = data
        .map((person, idx) => ({...person, originalIndex: idx}))
        .filter(person => person.name.toLowerCase().includes(filter.toLowerCase()));

      if(filteredData.length === 0){
        container.innerHTML = `<p>Không có dữ liệu phù hợp</p>`;
        return;
      }

      const grouped = groupByClass(filteredData);

      for (const className in grouped) {
        container.innerHTML += `<div class="group-title">Lớp ${className}</div>`;

        let tbodyHTML = "";

        grouped[className].forEach(person => {
          if(editingIndex === person.originalIndex && !addingNew) {
            tbodyHTML += `
              <tr>
                <td><input id="editName" value="${person.name}" /></td>
                <td><input id="editAge" type="number" value="${person.age}" /></td>
                <td><input id="editClass" value="${person.class}" /></td>
                <td><input id="editAddress" value="${person.address}" /></td>
                <td>
                  <select id="editHocphi">
                    <option value="Có" ${person.hocphi === "Có" ? "selected" : ""}>Có</option>
                    <option value="Không" ${person.hocphi === "Không" ? "selected" : ""}>Không</option>
                  </select>
                </td>
                <td>
                  <button onclick="saveEdit(${person.originalIndex})">Lưu</button>
                  <button onclick="cancelEdit()">Hủy</button>
                </td>
              </tr>
            `;
          } else {
            tbodyHTML += `
              <tr>
                <td>${person.name}</td>
                <td>${person.age}</td>
                <td>${person.class}</td>
                <td>${person.address}</td>
                <td>${person.hocphi}</td>
                <td>
                  <button onclick="startEdit(${person.originalIndex})">Chỉnh sửa</button>
                  <button onclick="deleteRow(${person.originalIndex})">Xóa</button>
                </td>
              </tr>
            `;
          }
        });

        // Nếu đang thêm mới và đang nhóm đầu tiên, thêm form thêm mới luôn
        if(addingNew) {
          tbodyHTML += `
            <tr>
              <td><input id="addName" placeholder="Tên" /></td>
              <td><input id="addAge" type="number" placeholder="Tuổi" /></td>
              <td><input id="addClass" placeholder="Lớp" /></td>
              <td><input id="addAddress" placeholder="Trường" /></td>
              <td>
                <select id="addHocphi">
                  <option value="Có">Có</option>
                  <option value="Không">Không</option>
                </select>
              </td>
              <td>
                <button onclick="addNewRow()">Thêm</button>
                <button onclick="cancelAdd()">Hủy</button>
              </td>
            </tr>
          `;
          // chỉ thêm 1 lần cho nhóm đầu tiên nên sau khi thêm xong tắt flag
          // (hoặc có thể thay đổi tùy ý)
          // addingNew = false;
        }

        container.innerHTML += `
          <table aria-live="polite" aria-label="Bảng lớp ${className}">
            <thead>
              <tr>
                <th>Tên</th>
                <th>Tuổi</th>
                <th>Lớp</th>
                <th>Trường</th>
                <th>Đóng học phí</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody>
              ${tbodyHTML}
            </tbody>
          </table>
        `;
      }
    }

    function filterTable() {
      const filterText = document.getElementById("nameInput").value.trim();
      editingIndex = -1;
      addingNew = false;
      renderTable(filterText);
    }

    function startEdit(index) {
      editingIndex = index;
      addingNew = false;
      renderTable(document.getElementById("nameInput").value.trim());
    }

    function cancelEdit() {
      editingIndex = -1;
      renderTable(document.getElementById("nameInput").value.trim());
    }

    function saveEdit(index) {
      const newName = document.getElementById("editName").value.trim();
      const newAge = parseInt(document.getElementById("editAge").value);
      const newClass = document.getElementById("editClass").value.trim();
      const newAddress = document.getElementById("editAddress").value.trim();
      const newHocphi = document.getElementById("editHocphi").value;

      if (!newName || isNaN(newAge) || !newClass || !newAddress) {
        alert("Vui lòng điền đầy đủ thông tin hợp lệ.");
        return;
      }

      data[index] = {
        name: newName,
        age: newAge,
        class: newClass,
        address: newAddress,
        hocphi: newHocphi
      };
      editingIndex = -1;
      renderTable(document.getElementById("nameInput").value.trim());
    }

    function deleteRow(index) {
      if (confirm("Bạn có chắc chắn muốn xóa người này không?")) {
        data.splice(index, 1);
        renderTable(document.getElementById("nameInput").value.trim());
      }
    }

    function showAddForm() {
      addingNew = true;
      editingIndex = -1;
      renderTable(document.getElementById("nameInput").value.trim());
    }

    function cancelAdd() {
      addingNew = false;
      renderTable(document.getElementById("nameInput").value.trim());
    }

    function addNewRow() {
      const newName = document.getElementById("addName").value.trim();
      const newAge = parseInt(document.getElementById("addAge").value);
      const newClass = document.getElementById("addClass").value.trim();
      const newAddress = document.getElementById("addAddress").value.trim();
      const newHocphi = document.getElementById("addHocphi").value;

      if (!newName || isNaN(newAge) || !newClass || !newAddress) {
        alert("Vui lòng điền đầy đủ thông tin hợp lệ.");
        return;
      }

      data.push({
        name: newName,
        age: newAge,
        class: newClass,
        address: newAddress,
        hocphi: newHocphi
      });

      addingNew = false;
      renderTable(document.getElementById("nameInput").value.trim());
    }

    // Khởi tạo bảng lúc đầu
    renderTable();
  </script>
</body>
</html>
