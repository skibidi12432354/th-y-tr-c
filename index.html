const data = [
  { name: "6.1-01 Anh", age: 11, class: "6.1", address: "THCS Nguyễn Trãi", hocphi: "Có" },
  { name: "6.1-02 An", age: 11, class: "6.1", address: "THCS Hùng Vương", hocphi: "Không" },
  { name: "6.2-01 Khang", age: 12, class: "6.2", address: "THCS Nguyễn Du", hocphi: "Có" }
];

let editingIndex = -1;
let addingNew = false;

function groupByClass(filteredData) {
  const groups = {};
  filteredData.forEach(person => {
    if (!groups[person.class]) groups[person.class] = [];
    groups[person.class].push(person);
  });
  return groups;
}

function renderTable(filter = "") {
  const container = document.getElementById("tablesContainer");
  container.innerHTML = "";

  const filteredData = data
    .map((person, idx) => ({ ...person, originalIndex: idx }))
    .filter(person => person.name.toLowerCase().includes(filter.toLowerCase()));

  if (filteredData.length === 0) {
    container.innerHTML = `<p>Không có dữ liệu phù hợp</p>`;
    return;
  }

  const grouped = groupByClass(filteredData);
  const class1 = "6.1";
  const class2 = "6.2";

  container.innerHTML = `
    <div>
      <div class="group-title">Lớp ${class1}</div>
      <table aria-live="polite" aria-label="Bảng lớp ${class1}">
        <thead>
          <tr>
            <th>Tên</th>
            <th>Tuổi</th>
            <th>Lớp</th>
            <th>Trường</th>
            <th>Đóng học phí</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody>
          ${renderRows(grouped[class1] || [], class1)}
        </tbody>
      </table>
    </div>
    <div>
      <div class="group-title">Lớp ${class2}</div>
      <table aria-live="polite" aria-label="Bảng lớp ${class2}">
        <thead>
          <tr>
            <th>Tên</th>
            <th>Tuổi</th>
            <th>Lớp</th>
            <th>Trường</th>
            <th>Đóng học phí</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody>
          ${renderRows(grouped[class2] || [], class2)}
        </tbody>
      </table>
    </div>
  `;
}

function renderRows(personList, className) {
  let rows = "";
  personList.forEach(person => {
    const idx = data.findIndex(p => p.name === person.name);
    if (editingIndex === idx && !addingNew) {
      rows += `
        <tr>
          <td><input id="editName" value="${person.name}" /></td>
          <td><input id="editAge" type="number" value="${person.age}" /></td>
          <td><input id="editClass" value="${person.class}" /></td>
          <td><input id="editAddress" value="${person.address}" /></td>
          <td>
            <select id="editHocphi">
              <option value="Có" ${person.hocphi === "Có" ? "selected" : ""}>Có</option>
              <option value="Không" ${person.hocphi === "Không" ? "selected" : ""}>Không</option>
            </select>
          </td>
          <td>
            <button onclick="saveEdit(${idx})">Lưu</button>
            <button onclick="cancelEdit()">Hủy</button>
          </td>
        </tr>
      `;
    } else {
      rows += `
        <tr>
          <td>${person.name}</td>
          <td>${person.age}</td>
          <td>${person.class}</td>
          <td>${person.address}</td>
          <td>${person.hocphi}</td>
          <td>
            <button onclick="startEdit(${idx})">Chỉnh sửa</button>
            <button onclick="deleteRow(${idx})">Xóa</button>
          </td>
        </tr>
      `;
    }
  });

  if (addingNew && className === "6.1") {
    rows += `
      <tr>
        <td><input id="addName" placeholder="Tên" /></td>
        <td><input id="addAge" type="number" placeholder="Tuổi" /></td>
        <td><input id="addClass" placeholder="Lớp" /></td>
        <td><input id="addAddress" placeholder="Trường" /></td>
        <td>
          <select id="addHocphi">
            <option value="Có">Có</option>
            <option value="Không">Không</option>
          </select>
        </td>
        <td>
          <button onclick="addNewRow()">Thêm</button>
          <button onclick="cancelAdd()">Hủy</button>
        </td>
      </tr>
    `;
  }

  return rows;
}

function filterTable() {
  const filterText = document.getElementById("nameInput").value.trim();
  editingIndex = -1;
  addingNew = false;
  renderTable(filterText);
}

function startEdit(index) {
  editingIndex = index;
  addingNew = false;
  renderTable(document.getElementById("nameInput").value.trim());
}

function cancelEdit() {
  editingIndex = -1;
  renderTable(document.getElementById("nameInput").value.trim());
}

function saveEdit(index) {
  const newName = document.getElementById("editName").value.trim();
  const newAge = parseInt(document.getElementById("editAge").value);
  const newClass = document.getElementById("editClass").value.trim();
  const newAddress = document.getElementById("editAddress").value.trim();
  const newHocphi = document.getElementById("editHocphi").value;

  if (!newName || isNaN(newAge) || !newClass || !newAddress) {
    alert("Vui lòng điền đầy đủ thông tin hợp lệ.");
    return;
  }

  data[index] = {
    name: newName,
    age: newAge,
    class: newClass,
    address: newAddress,
    hocphi: newHocphi
  };
  editingIndex = -1;
  renderTable(document.getElementById("nameInput").value.trim());
}

function deleteRow(index) {
  if (confirm("Bạn có chắc muốn xóa học sinh này?")) {
    data.splice(index, 1);
    renderTable(document.getElementById("nameInput").value.trim());
  }
}

function showAddForm() {
  if (!addingNew) {
    addingNew = true;
    editingIndex = -1;
    renderTable(document.getElementById("nameInput").value.trim());
  }
}

function addNewRow() {
  const name = document.getElementById("addName").value.trim();
  const age = parseInt(document.getElementById("addAge").value);
  const className = document.getElementById("addClass").value.trim();
  const address = document.getElementById("addAddress").value.trim();
  const hocphi = document.getElementById("addHocphi").value;

  if (!name || isNaN(age) || !className || !address) {
    alert("Vui lòng điền đầy đủ thông tin hợp lệ.");
    return;
  }

  data.push({ name, age, class: className, address, hocphi });
  addingNew = false;
  renderTable(document.getElementById("nameInput").value.trim());
}

function cancelAdd() {
  addingNew = false;
  renderTable(document.getElementById("nameInput").value.trim());
}

// Khởi tạo bảng lần đầu
renderTable();
